{{ if .Values.ingress.enabled }}
---
{
  apiVersion: "networking.k8s.io/v1",
  kind: "Ingress",
  metadata: {
    name: "{{ include `aid.fullname` . }}",
    namespace: "{{ include `aid.namespace` . }}",
    annotations: {
      kubernetes.io/ingress.class: "alb",
      alb.ingress.kubernetes.io/actions.ssl-redirect: "{\"Type\": \"redirect\", \"RedirectConfig\": { \"Protocol\": \"HTTPS\", \"Port\": \"443\", \"StatusCode\": \"HTTP_301\"}}",
      alb.ingress.kubernetes.io/ssl-policy: "ELBSecurityPolicy-TLS13-1-2-2021-06",
      alb.ingress.kubernetes.io/scheme: "internet-facing",
      alb.ingress.kubernetes.io/target-group-attributes: "load_balancing.algorithm.type=least_outstanding_requests",
{{/*      alb.ingress.kubernetes.io/target-group-attributes: "load_balancing.algorithm.type=weighted_random,load_balancing.algorithm.anomaly_mitigation=on",*/}}
      alb.ingress.kubernetes.io/load-balancer-attributes: "routing.http2.enabled=true",
      alb.ingress.kubernetes.io/backend-protocol: "HTTP",
      alb.ingress.kubernetes.io/healthcheck-protocol: "HTTP",
      alb.ingress.kubernetes.io/healthcheck-path: "/",
      alb.ingress.kubernetes.io/target-type: "ip",
      alb.ingress.kubernetes.io/listen-ports: "[{\"HTTPS\":443},{\"HTTP\":80}]",
      alb.ingress.kubernetes.io/group.name: "{{ include `aid.namespace` . }}-zengine",
      alb.ingress.kubernetes.io/tags: "env={{ include `aid.namespace` . }}, stack=zengineV1",
      {{- if .Values.ingress.waf_arn }}
      alb.ingress.kubernetes.io/wafv2-acl-arn: "{{ .Values.ingress.waf_arn }}",
      {{- end }}
      external-dns.alpha.kubernetes.io/hostname: "{{ .Values.ingress.hostname }}",
    },
    labels: {
      stack: "zengineV1",
      application: "{{ include `aid.fullname` . }}",
    },
  },
  spec: {
    rules: [{
      host: "{{ .Values.ingress.hostname }}",
        http: {
          paths: [{
            path: "/",
            pathType: "Prefix",
            backend: {
              service: {
                name: "{{ include `aid.fullname` . }}",
                port: {
                  name: "http"
                },
              },
            },
          }],
        },
    }],
  },
}
{{ end }}
